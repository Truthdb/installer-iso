name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Generate release notes
        id: release_notes
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          
          # Generate changelog
          if [ -z "$PREV_TAG" ]; then
            echo "First release"
            CHANGELOG="Initial release of TruthDB Installer ISO"
          else
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          fi
          
          # Create release body
          cat > release_notes.md << EOF
          ## TruthDB Installer ISO ${GITHUB_REF#refs/tags/v}
          
          ### Changes
          $CHANGELOG
          
          ### Installation
          
          Download the \`truthdb-installer.iso\` file and boot from it on a compatible x86_64 system with UEFI support.
          
          ### Components
          
          This ISO includes:
          - TruthDB Installer (version ${GITHUB_REF#refs/tags/v})
          - TruthDB Installer Kernel (version ${GITHUB_REF#refs/tags/v})
          EOF
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ steps.get_version.outputs.version }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false

  build-and-upload:
    name: Build and Upload ISO
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ca-certificates curl git \
            build-essential pkg-config \
            cpio zstd \
            busybox-static \
            python3 \
            systemd-ukify \
            systemd-boot-efi \
            file \
            xorriso \
            dosfstools mtools \
            jq
      
      - name: Download matching installer binary
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          echo "Looking for installer version v${VERSION}"
          
          # Try to get the matching release from installer repo
          RELEASE=$(curl -s https://api.github.com/repos/Truthdb/installer/releases/tags/v${VERSION})
          
          # Check if the release exists
          if echo "$RELEASE" | jq -e '.message == "Not Found"' > /dev/null; then
            echo "No matching release v${VERSION} found in installer repo"
            echo "Falling back to latest release"
            RELEASE=$(curl -s https://api.github.com/repos/Truthdb/installer/releases/latest)
          fi
          
          # Download the installer binary
          DOWNLOAD_URL=$(echo "$RELEASE" | jq -r '.assets[] | select(.name | contains("truthdb-installer")) | select(.name | endswith(".tar.gz")) | .browser_download_url')
          
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "No installer binary found in release"
            exit 1
          fi
          
          echo "Downloading installer from: $DOWNLOAD_URL"
          mkdir -p installer-bin
          cd installer-bin
          curl -L -o installer.tar.gz "$DOWNLOAD_URL"
          tar xzf installer.tar.gz
          chmod +x truthdb-installer
          cd ..
          
          # Verify the binary exists
          ls -lh installer-bin/truthdb-installer
          file installer-bin/truthdb-installer
      
      - name: Download matching kernel
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          echo "Looking for kernel version ${VERSION}"
          
          # Try to get the matching release from installer-kernel repo
          RELEASE=$(curl -s https://api.github.com/repos/Truthdb/installer-kernel/releases/tags/${VERSION})
          
          # Check if the release exists
          if echo "$RELEASE" | jq -e '.message == "Not Found"' > /dev/null; then
            echo "No matching release ${VERSION} found in installer-kernel repo"
            echo "Falling back to latest release"
            RELEASE=$(curl -s https://api.github.com/repos/Truthdb/installer-kernel/releases/latest)
          fi
          
          # Download the kernel (BOOTX64.EFI)
          DOWNLOAD_URL=$(echo "$RELEASE" | jq -r '.assets[] | select(.name == "BOOTX64.EFI") | .browser_download_url')
          
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "No BOOTX64.EFI found in release"
            exit 1
          fi
          
          echo "Downloading kernel from: $DOWNLOAD_URL"
          mkdir -p kernel-bin
          curl -L -o kernel-bin/BOOTX64.EFI "$DOWNLOAD_URL"
          
          # Verify the kernel exists
          ls -lh kernel-bin/BOOTX64.EFI
          file kernel-bin/BOOTX64.EFI
      
      - name: Build ISO
        run: |
          # Set environment variables for the build
          export KERNEL_SRC="${PWD}/kernel-bin/BOOTX64.EFI"
          export INSTALLER_BIN="${PWD}/installer-bin/truthdb-installer"
          export ISO_NAME="truthdb-installer.iso"
          
          # Verify files exist
          ls -lh "$KERNEL_SRC" "$INSTALLER_BIN"
          
          # Build the initramfs
          rm -rf rootfs
          mkdir -p rootfs/{bin,sbin,etc,proc,sys,dev,run,tmp}
          
          cp /bin/busybox rootfs/bin/busybox
          chmod +x rootfs/bin/busybox
          ln -sf /bin/busybox rootfs/sbin/init
          ln -sf /bin/busybox rootfs/bin/sh
          
          cp "$INSTALLER_BIN" rootfs/bin/truthdb-installer
          chmod +x rootfs/bin/truthdb-installer
          
          cat > rootfs/etc/inittab <<'EOF'
          ::sysinit:/bin/busybox mount -t proc proc /proc
          ::sysinit:/bin/busybox mount -t sysfs sysfs /sys
          ::sysinit:/bin/busybox mount -t devtmpfs devtmpfs /dev
          ::respawn:/bin/truthdb-installer
          ::restart:/bin/busybox reboot -f
          EOF
          
          rm -f initramfs.cpio initramfs.cpio.zst
          ( cd rootfs && find . -print0 | cpio --null -ov --format=newc ) > initramfs.cpio
          zstd -19 -T0 initramfs.cpio -o initramfs.cpio.zst
          
          # Create cmdline
          cat > cmdline.txt <<'EOF'
          console=ttyS0 earlyprintk=serial loglevel=7 rdinit=/sbin/init
          EOF
          
          # Build UKI
          cp "$KERNEL_SRC" ./vmlinuz
          
          ukify build \
            --linux ./vmlinuz \
            --initrd ./initramfs.cpio.zst \
            --cmdline @./cmdline.txt \
            --output ./TruthDBInstaller.efi
          
          file ./TruthDBInstaller.efi
          
          # Create EFI image
          rm -f efi.img
          dd if=/dev/zero of=efi.img bs=1M count=128
          mkfs.vfat -F 32 efi.img
          
          mmd   -i efi.img ::/EFI
          mmd   -i efi.img ::/EFI/BOOT
          mcopy -i efi.img ./TruthDBInstaller.efi ::/EFI/BOOT/BOOTX64.EFI
          
          # Create ISO
          rm -f "$ISO_NAME"
          
          xorriso -as mkisofs \
            -R -J \
            -o "$ISO_NAME" \
            -eltorito-alt-boot \
            -e efi.img \
            -no-emul-boot \
            -isohybrid-gpt-basdat \
            -graft-points efi.img=efi.img
          
          echo "ISO ready: $ISO_NAME"
          ls -lh "$ISO_NAME"
      
      - name: Generate checksum
        run: |
          sha256sum truthdb-installer.iso > truthdb-installer-v${{ needs.create-release.outputs.version }}.iso.sha256
          cat truthdb-installer-v${{ needs.create-release.outputs.version }}.iso.sha256
      
      - name: Upload Release Asset - ISO
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./truthdb-installer.iso
          asset_name: truthdb-installer-v${{ needs.create-release.outputs.version }}.iso
          asset_content_type: application/x-iso9660-image
      
      - name: Upload Release Asset - Checksum
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./truthdb-installer-v${{ needs.create-release.outputs.version }}.iso.sha256
          asset_name: truthdb-installer-v${{ needs.create-release.outputs.version }}.iso.sha256
          asset_content_type: text/plain
